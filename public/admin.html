<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | Tejas Computer Institute</title>
    <meta name="description" content="Admin dashboard to view inquiry submissions">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Main Stylesheet -->
    <link rel="stylesheet" href="css/style.css">
    
    <style>
        /* Admin Specific Styles */
        .admin-container {
            max-width: 1400px;
            margin: 100px auto 50px;
            padding: 0 20px;
        }
        
        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
        }
        
        .admin-header h1 {
            color: var(--primary-color);
        }
        
        .admin-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .admin-stat-card {
            background: var(--white);
            padding: 25px;
            border-radius: 15px;
            box-shadow: var(--shadow);
            text-align: center;
        }
        
        .admin-stat-card h3 {
            font-size: 2.5rem;
            color: var(--primary-color);
            margin-bottom: 5px;
        }
        
        .admin-stat-card p {
            color: var(--gray-text);
            font-weight: 500;
        }
        
        .inquiries-table {
            background: var(--white);
            border-radius: 20px;
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .users-table {
            background: var(--white);
            border-radius: 20px;
            box-shadow: var(--shadow);
            overflow: hidden;
            margin-top: 35px;
        }

        .admin-utility-grid {
            display: grid;
            grid-template-columns: 1.3fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .admin-card {
            background: var(--white);
            border-radius: 16px;
            box-shadow: var(--shadow);
            padding: 20px;
        }

        .admin-card h3 {
            color: var(--primary-color);
            margin-bottom: 8px;
            font-size: 1.2rem;
        }

        .admin-card p {
            margin-bottom: 14px;
        }

        .announcement-form .form-group {
            margin-bottom: 12px;
        }

        .announcement-form label {
            font-weight: 600;
            display: block;
            margin-bottom: 6px;
        }

        .announcement-form input,
        .announcement-form textarea,
        .announcement-form select {
            width: 100%;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 10px 12px;
            font-family: inherit;
        }

        .announcement-form textarea {
            min-height: 84px;
            resize: vertical;
        }

        .inline-fields {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 10px;
            align-items: end;
        }

        .switch-line {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        .announce-status {
            margin-top: 8px;
            font-size: 0.92rem;
            color: var(--gray-text);
        }

        .insight-box {
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 10px;
            background: var(--light-bg);
        }

        .insight-box strong {
            color: var(--primary-dark);
        }

        .admin-enhancement-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .control-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }

        .control-row input,
        .control-row select {
            width: 100%;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 10px 12px;
            font-family: inherit;
        }

        .mini-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .btn-outline-admin {
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
            background: transparent;
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 0.9rem;
            cursor: pointer;
        }

        .btn-outline-admin:hover {
            background: rgba(var(--primary-rgb), 0.1);
        }

        .theme-manager-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 10px;
            margin-top: 8px;
        }

        .theme-manager-btn {
            border: 1px solid var(--border-color);
            background: var(--light-bg);
            border-radius: 10px;
            padding: 10px 12px;
            text-align: left;
            color: var(--dark-text);
            cursor: pointer;
            font-size: 0.92rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .theme-manager-btn i {
            color: var(--primary-color);
            width: 16px;
        }

        .theme-manager-btn:hover {
            border-color: var(--primary-color);
        }

        .theme-manager-btn.active {
            border-color: var(--primary-color);
            background: rgba(var(--primary-rgb), 0.14);
            color: var(--primary-dark);
            font-weight: 600;
        }

        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            background: var(--light-bg);
            margin-bottom: 8px;
        }

        .leaderboard-item:last-child {
            margin-bottom: 0;
        }

        .leaderboard-rank {
            font-weight: 700;
            color: var(--primary-color);
            margin-right: 8px;
        }

        .activity-feed {
            display: grid;
            gap: 8px;
            max-height: 270px;
            overflow: auto;
            padding-right: 3px;
        }

        .price-list {
            display: grid;
            gap: 8px;
            max-height: 270px;
            overflow: auto;
            padding-right: 3px;
        }

        .price-item {
            border: 1px solid var(--border-color);
            border-radius: 10px;
            background: var(--light-bg);
            padding: 10px 12px;
            display: flex;
            justify-content: space-between;
            gap: 10px;
            align-items: center;
        }

        .price-title {
            font-weight: 600;
            color: var(--primary-dark);
        }

        .price-editor {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .price-input {
            width: 120px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 7px 10px;
            font-family: inherit;
            text-align: right;
        }

        .price-save-btn {
            border: 1px solid var(--primary-color);
            background: var(--primary-color);
            color: var(--white);
            border-radius: 8px;
            padding: 7px 12px;
            font-size: 0.86rem;
            cursor: pointer;
            white-space: nowrap;
        }

        .price-save-btn:hover {
            background: var(--primary-dark);
            border-color: var(--primary-dark);
        }

        .price-save-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .price-note {
            font-size: 0.82rem;
            color: var(--gray-text);
        }

        .activity-item {
            border: 1px solid var(--border-color);
            border-radius: 10px;
            background: var(--light-bg);
            padding: 10px 12px;
        }

        .activity-item strong {
            color: var(--primary-dark);
        }

        .small-muted {
            color: var(--gray-text);
            font-size: 0.85rem;
            margin-top: 2px;
        }
        
        .table-header {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            padding: 20px 30px;
            color: var(--white);
        }
        
        .table-header h2 {
            color: var(--white);
            font-size: 1.5rem;
            margin: 0;
        }
        
        .table-responsive {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 15px 20px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        
        th {
            background: var(--light-bg);
            font-weight: 600;
            color: var(--dark-text);
        }
        
        tr:hover {
            background: var(--light-bg);
        }
        
        .badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }
        
        .badge-primary {
            background: rgba(var(--primary-rgb), 0.12);
            color: var(--primary-color);
        }
        
        .badge-success {
            background: rgba(40, 167, 69, 0.1);
            color: var(--success);
        }

        .badge-warning {
            background: rgba(220, 53, 69, 0.12);
            color: #c82333;
        }
        
        .date {
            color: var(--gray-text);
            font-size: 0.9rem;
        }
        
        .no-inquiries {
            text-align: center;
            padding: 60px 20px;
            color: var(--gray-text);
        }
        
        .no-inquiries i {
            font-size: 4rem;
            color: var(--border-color);
            margin-bottom: 20px;
        }
        
        .btn-refresh {
            background: var(--white);
            color: var(--primary-color);
            border: 2px solid var(--white);
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
        }
        
        .btn-refresh:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .table-action-btn {
            border: 1px solid var(--border-color);
            background: var(--white);
            border-radius: 6px;
            padding: 6px 9px;
            font-size: 0.8rem;
            cursor: pointer;
            margin-right: 6px;
        }

        .table-action-btn:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        .table-action-btn.danger {
            border-color: #f3c7cb;
            color: #b52a37;
        }

        .table-action-btn.danger:hover {
            border-color: #b52a37;
            color: #b52a37;
            background: #fff5f6;
        }

        .btn-logout-admin {
            background: #dc3545;
            color: var(--white);
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
            margin-left: 10px;
        }

        .btn-logout-admin:hover {
            background: #c82333;
        }

        .admin-actions {
            display: flex;
            align-items: center;
        }

        .admin-login-box {
            max-width: 460px;
            margin: 120px auto 40px;
            background: var(--white);
            border-radius: 16px;
            box-shadow: var(--shadow);
            padding: 30px;
        }

        .admin-login-box h2 {
            margin-bottom: 10px;
            color: var(--primary-color);
        }

        .admin-login-box p {
            margin-bottom: 20px;
        }

        .admin-login-box .form-group {
            margin-bottom: 16px;
        }

        .admin-login-box label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .admin-login-box input {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-family: inherit;
        }

        .admin-login-box input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .admin-login-error {
            display: none;
            margin-top: 12px;
            color: #dc3545;
            font-size: 0.95rem;
        }
        
        @media (max-width: 992px) {
            .admin-stats {
                grid-template-columns: repeat(2, 1fr);
            }

            .admin-utility-grid {
                grid-template-columns: 1fr;
            }

            .admin-enhancement-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .admin-stats {
                grid-template-columns: 1fr;
            }
            
            .table-responsive {
                font-size: 0.9rem;
            }
            
            th, td {
                padding: 12px 15px;
            }

            .control-row {
                grid-template-columns: 1fr;
            }

            .theme-manager-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <nav class="navbar">
                <a href="index.html" class="logo">
                    <div class="logo-icon">TC</div>
                    <div class="logo-text">Tejas <span>Computer</span></div>
                </a>
                
                <ul class="nav-menu">
                    <li><a href="index.html" class="nav-link">Home</a></li>
                    <li><a href="admin.html" class="nav-link active">Admin</a></li>
                    <li><a href="contact.html" class="nav-link">Contact</a></li>
                </ul>
                
                <div class="hamburger">
                    <span class="bar"></span>
                    <span class="bar"></span>
                    <span class="bar"></span>
                </div>
            </nav>
        </div>
    </header>

    <!-- Admin Dashboard -->
    <div class="admin-container">
        <div class="admin-header">
            <div>
                <h1><i class="fas fa-user-shield"></i> Admin Dashboard</h1>
                <p style="margin-top: 5px;">Manage your institute inquiries and applications</p>
            </div>
            <div class="admin-actions">
                <button class="btn-refresh" onclick="refreshAll()">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
                <button class="btn-logout-admin" onclick="logoutAdmin()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </div>
        
        <!-- Stats -->
        <div class="admin-stats">
            <div class="admin-stat-card">
                <h3 id="totalInquiries">0</h3>
                <p>Total Inquiries</p>
            </div>
            <div class="admin-stat-card">
                <h3 id="todayInquiries">0</h3>
                <p>Today's Inquiries</p>
            </div>
            <div class="admin-stat-card">
                <h3 id="pythonInquiries">0</h3>
                <p>Python Course</p>
            </div>
            <div class="admin-stat-card">
                <h3 id="webInquiries">0</h3>
                <p>Web Development</p>
            </div>
            <div class="admin-stat-card">
                <h3 id="totalUsers">0</h3>
                <p>Total Registrations</p>
            </div>
            <div class="admin-stat-card">
                <h3 id="todayRegistrations">0</h3>
                <p>Today's Registrations</p>
            </div>
        </div>

        <div class="admin-utility-grid">
            <div class="admin-card">
                <h3><i class="fas fa-bullhorn"></i> Announcement Manager</h3>
                <p>Publish a site-wide notice that appears at the top of all pages.</p>
                <form id="announcementForm" class="announcement-form">
                    <div class="form-group">
                        <label for="announcementTitle">Title (Optional)</label>
                        <input id="announcementTitle" maxlength="80" placeholder="Example: Weekend Batch Update">
                    </div>
                    <div class="form-group">
                        <label for="announcementMessage">Message</label>
                        <textarea id="announcementMessage" maxlength="220" placeholder="Example: New weekend batch starts from 5 March."></textarea>
                        <div class="small-muted"><span id="announcementCharCount">0</span>/220</div>
                    </div>
                    <div class="inline-fields">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="announcementType">Type</label>
                            <select id="announcementType">
                                <option value="info">Info (Blue)</option>
                                <option value="success">Success (Green)</option>
                                <option value="warning">Warning (Amber)</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary">Save Notice</button>
                    </div>
                    <div class="control-row">
                        <input id="announcementCtaText" maxlength="40" placeholder="CTA text (optional), ex: Apply Now">
                        <input id="announcementCtaUrl" maxlength="240" placeholder="CTA URL (optional), ex: https://example.com">
                    </div>
                    <div class="control-row">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="announcementStartsAt">Start Time</label>
                            <input id="announcementStartsAt" type="datetime-local">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="announcementEndsAt">End Time</label>
                            <input id="announcementEndsAt" type="datetime-local">
                        </div>
                    </div>
                    <div class="switch-line">
                        <input type="checkbox" id="announcementActive">
                        <label for="announcementActive" style="margin: 0;">Show this announcement live</label>
                    </div>
                    <div class="switch-line">
                        <input type="checkbox" id="announcementDismissible" checked>
                        <label for="announcementDismissible" style="margin: 0;">Allow users to dismiss this announcement</label>
                    </div>
                    <div class="mini-actions">
                        <button type="button" class="btn-outline-admin" id="announcementActivateNowBtn"><i class="fas fa-bolt"></i> Activate Now</button>
                        <button type="button" class="btn-outline-admin" id="announcementDeactivateBtn"><i class="fas fa-pause"></i> Deactivate</button>
                        <button type="button" class="btn-outline-admin" id="announcementClearBtn"><i class="fas fa-eraser"></i> Clear</button>
                    </div>
                    <div id="announcementPreview" class="insight-box" style="margin-top: 10px;">
                        <div class="small-muted">Preview will appear here.</div>
                    </div>
                    <div class="announce-status" id="announcementStatus">Loading announcement...</div>
                </form>
            </div>

            <div class="admin-card">
                <h3><i class="fas fa-wand-magic-sparkles"></i> Smart Insights</h3>
                <p>Quick guidance based on current leads and registrations.</p>
                <div class="insight-box">
                    <div>Top demand course</div>
                    <strong id="insightTopCourse">-</strong>
                </div>
                <div class="insight-box">
                    <div>Today's leads</div>
                    <strong id="insightTodayLeads">0</strong>
                </div>
                <div class="insight-box">
                    <div>Today's registrations</div>
                    <strong id="insightTodayRegistrations">0</strong>
                </div>
                <div class="announce-status" id="insightSuggestion">Suggestion will appear here.</div>
            </div>
        </div>

        <div class="admin-enhancement-grid">
            <div class="admin-card">
                <h3><i class="fas fa-sliders"></i> Data Controls</h3>
                <p>Filter and export inquiries/users quickly.</p>
                <div class="control-row">
                    <input id="inquirySearchInput" type="text" placeholder="Search inquiry by name/email/course">
                    <select id="inquiryCourseFilter">
                        <option value="">All Inquiry Courses</option>
                    </select>
                </div>
                <div class="control-row">
                    <input id="userSearchInput" type="text" placeholder="Search user by name/email/course">
                    <select id="userCourseFilter">
                        <option value="">All User Courses</option>
                    </select>
                </div>
                <div class="mini-actions">
                    <button class="btn-outline-admin" id="exportInquiriesBtn"><i class="fas fa-file-csv"></i> Export Inquiries CSV</button>
                    <button class="btn-outline-admin" id="exportUsersBtn"><i class="fas fa-file-csv"></i> Export Users CSV</button>
                </div>
            </div>

            <div class="admin-card">
                <h3><i class="fas fa-chart-line"></i> Demand Leaderboard</h3>
                <p>Top courses based on inquiry and registration activity.</p>
                <div id="courseLeaderboard">
                    <div class="small-muted">Loading demand data...</div>
                </div>
            </div>

            <div class="admin-card">
                <h3><i class="fas fa-palette"></i> Theme Manager</h3>
                <p>Choose a site theme. The selected theme is applied across your project.</p>
                <div id="adminThemeGrid" class="theme-manager-grid">
                    <div class="small-muted">Loading themes...</div>
                </div>
                <div class="mini-actions">
                    <button type="button" class="btn-outline-admin" id="resetThemeBtn">
                        <i class="fas fa-rotate-left"></i> Reset Default Theme
                    </button>
                </div>
                <div class="announce-status" id="adminThemeStatus">Theme controls loading...</div>
            </div>

            <div class="admin-card">
                <h3><i class="fas fa-tags"></i> Course Pricing</h3>
                <p>Current course fees from catalog.</p>
                <div id="coursePriceList" class="price-list">
                    <div class="small-muted">Loading course prices...</div>
                </div>
                <div class="announce-status" id="coursePricingStatus">Use the Save button to update each course fee.</div>
            </div>
        </div>

        <div class="admin-card" style="margin-bottom: 30px;">
            <h3><i class="fas fa-gamepad"></i> Gamification Control Center</h3>
            <p>Tune XP rewards, level curve, and weekly challenge goals.</p>
            <div class="control-row">
                <input id="gameXpPerLevel" type="number" min="50" placeholder="XP per level">
                <input id="gameEnrollXp" type="number" min="0" placeholder="Enroll XP reward">
            </div>
            <div class="control-row">
                <input id="gameTopicXp" type="number" min="0" placeholder="XP per completed topic">
                <input id="gameCompletionXp" type="number" min="0" placeholder="Course completion bonus XP">
            </div>
            <div class="control-row">
                <input id="gameDailyBaseXp" type="number" min="0" placeholder="Daily base XP">
                <input id="gameDailyStreakFactor" type="number" min="0" placeholder="Daily streak factor">
            </div>
            <div class="control-row">
                <input id="gameDailyStreakCap" type="number" min="0" placeholder="Daily streak cap XP">
                <input id="gameWeeklyTargetTopics" type="number" min="1" placeholder="Weekly target topics">
            </div>
            <div class="control-row">
                <input id="gameWeeklyRewardXp" type="number" min="0" placeholder="Weekly reward XP">
                <input id="gameWeeklyLabel" maxlength="80" placeholder="Weekly challenge label">
            </div>
            <div class="mini-actions">
                <button type="button" class="btn-outline-admin" id="saveGamificationBtn"><i class="fas fa-save"></i> Save Gamification</button>
                <button type="button" class="btn-outline-admin" id="resetGamificationBtn"><i class="fas fa-rotate-left"></i> Reset Form</button>
            </div>
            <div class="announce-status" id="gamificationStatus">Loading gamification settings...</div>
        </div>

        <div class="admin-card" style="margin-bottom: 30px;">
            <h3><i class="fas fa-clock-rotate-left"></i> Recent Activity</h3>
            <p>Combined timeline of latest inquiries and new registrations.</p>
            <div id="recentActivity" class="activity-feed">
                <div class="small-muted">Loading recent activity...</div>
            </div>
        </div>
        
        <!-- Inquiries Table -->
        <div class="inquiries-table">
            <div class="table-header">
                <h2><i class="fas fa-envelope"></i> Inquiry Submissions</h2>
            </div>
            
            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Phone</th>
                            <th>Course</th>
                            <th>Status</th>
                            <th>Message</th>
                            <th>Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="inquiriesTable">
                        <tr>
                            <td colspan="9" class="no-inquiries">
                                <i class="fas fa-inbox"></i>
                                <p>Loading inquiries...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Registered Users Table -->
        <div class="users-table">
            <div class="table-header">
                <h2><i class="fas fa-users"></i> Registered Users</h2>
            </div>
            
            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>First Name</th>
                            <th>Last Name</th>
                            <th>Email</th>
                            <th>Phone</th>
                            <th>Course</th>
                            <th>Status</th>
                            <th>Registered On</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="usersTable">
                        <tr>
                            <td colspan="9" class="no-inquiries">
                                <i class="fas fa-user-clock"></i>
                                <p>Loading users...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="js/main.js"></script>
    
    <script>
        const ADMIN_TOKEN_KEY = 'adminToken';
        let inquiriesCache = [];
        let usersCache = [];
        let gamificationConfigCache = null;
        let courseCatalogCache = [];
        const savingCoursePriceSlugs = new Set();

        // Load admin data on page load
        document.addEventListener('DOMContentLoaded', async function() {
            const isAuthenticated = await verifyAdminSession();
            if (isAuthenticated) {
                refreshAll();
            } else {
                showAdminLogin();
            }
        });

        function getAdminToken() {
            return localStorage.getItem(ADMIN_TOKEN_KEY);
        }

        function authHeaders() {
            return {
                'Authorization': `Bearer ${getAdminToken()}`
            };
        }

        async function verifyAdminSession() {
            const token = getAdminToken();
            if (!token) return false;

            try {
                const response = await fetch('/api/admin/session', {
                    headers: authHeaders()
                });
                return response.ok;
            } catch (error) {
                return false;
            }
        }

        function showAdminLogin() {
            const container = document.querySelector('.admin-container');
            container.innerHTML = `
                <div class="admin-login-box">
                    <h2><i class="fas fa-lock"></i> Admin Login</h2>
                    <p>Enter admin credentials to access dashboard data.</p>
                    <form id="adminLoginForm">
                        <div class="form-group">
                            <label for="adminUsername">Username</label>
                            <input type="text" id="adminUsername" required />
                        </div>
                        <div class="form-group">
                            <label for="adminPassword">Password</label>
                            <input type="password" id="adminPassword" required />
                        </div>
                        <button type="submit" class="btn btn-primary" style="width: 100%;">Login</button>
                        <div class="admin-login-error" id="adminLoginError"></div>
                    </form>
                </div>
            `;

            const form = document.getElementById('adminLoginForm');
            form.addEventListener('submit', handleAdminLogin);
        }

        async function handleAdminLogin(e) {
            e.preventDefault();

            const username = document.getElementById('adminUsername').value.trim();
            const password = document.getElementById('adminPassword').value;
            const errorBox = document.getElementById('adminLoginError');

            try {
                const response = await fetch('/api/admin/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await response.json();

                if (!response.ok || !data.success) {
                    errorBox.style.display = 'block';
                    errorBox.textContent = data.message || 'Admin login failed';
                    return;
                }

                localStorage.setItem(ADMIN_TOKEN_KEY, data.token);
                window.location.reload();
            } catch (error) {
                errorBox.style.display = 'block';
                errorBox.textContent = 'Network error. Please try again.';
            }
        }

        async function logoutAdmin() {
            try {
                await fetch('/api/admin/logout', {
                    method: 'POST',
                    headers: authHeaders()
                });
            } catch (error) {
                // Ignore network errors here, local logout still happens.
            } finally {
                localStorage.removeItem(ADMIN_TOKEN_KEY);
                window.location.reload();
            }
        }

        async function refreshAll() {
            await Promise.all([
                loadInquiries(),
                loadUsers(),
                loadAnnouncement(),
                loadInsights(),
                loadGamificationConfig(),
                loadCoursePricing()
            ]);
            renderThemeManager();
            setThemeStatus(`Active theme: ${getCurrentThemeFromMain()}`);
        }

        function getThemeCatalogFromMain() {
            if (typeof window.getThemeCatalog === 'function') {
                return window.getThemeCatalog();
            }
            return [{ id: 'light', label: 'Light Classic', icon: 'fa-sun' }];
        }

        function getCurrentThemeFromMain() {
            if (typeof window.getCurrentTheme === 'function') {
                return window.getCurrentTheme();
            }
            return 'light';
        }

        function setThemeStatus(message) {
            const status = document.getElementById('adminThemeStatus');
            if (status) status.textContent = message;
        }

        function renderThemeManager() {
            const host = document.getElementById('adminThemeGrid');
            if (!host) return;

            const themes = getThemeCatalogFromMain();
            const activeTheme = getCurrentThemeFromMain();

            host.innerHTML = themes.map(theme => `
                <button type="button" class="theme-manager-btn ${theme.id === activeTheme ? 'active' : ''}" data-admin-theme="${theme.id}">
                    <i class="fas ${theme.icon || 'fa-palette'}"></i>
                    <span>${theme.label || theme.id}</span>
                </button>
            `).join('');

            host.querySelectorAll('[data-admin-theme]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const themeId = btn.getAttribute('data-admin-theme');
                    if (typeof window.applySiteTheme === 'function') {
                        window.applySiteTheme(themeId);
                    }
                    renderThemeManager();
                    const themeName = btn.textContent.trim();
                    setThemeStatus(`Theme changed to ${themeName}.`);
                });
            });
        }

        function resetThemeToDefault() {
            if (typeof window.applySiteTheme === 'function') {
                window.applySiteTheme('light');
                renderThemeManager();
                setThemeStatus('Theme reset to Light Classic.');
            } else {
                setThemeStatus('Theme engine is unavailable.');
            }
        }

        function formatCoursePrice(course = {}) {
            if (course.priceLabel) return course.priceLabel;
            const value = Number(course.price);
            if (Number.isFinite(value) && value > 0) {
                return `INR ${Math.round(value).toLocaleString('en-IN')}`;
            }
            return 'Price on request';
        }

        async function loadCoursePricing() {
            const host = document.getElementById('coursePriceList');
            const status = document.getElementById('coursePricingStatus');
            if (!host) return;
            try {
                const response = await fetch('/api/admin/course-pricing', {
                    headers: authHeaders()
                });
                if (response.status === 401) {
                    localStorage.removeItem(ADMIN_TOKEN_KEY);
                    showAdminLogin();
                    return;
                }
                const data = await response.json();
                if (!response.ok || !data.success) {
                    host.innerHTML = `<div class="small-muted">${data.message || 'Unable to load prices right now.'}</div>`;
                    if (status) status.textContent = data.message || 'Failed to load course prices.';
                    courseCatalogCache = [];
                    return;
                }
                courseCatalogCache = Array.isArray(data.courses) ? data.courses : [];
                renderCoursePricing();
                if (status) status.textContent = 'Course pricing loaded.';
            } catch (error) {
                host.innerHTML = `<div class="small-muted">Unable to load prices right now.</div>`;
                if (status) status.textContent = 'Network error while loading course prices.';
                courseCatalogCache = [];
            }
        }

        function renderCoursePricing() {
            const host = document.getElementById('coursePriceList');
            if (!host) return;
            if (!courseCatalogCache.length) {
                host.innerHTML = `<div class="small-muted">No course pricing available yet.</div>`;
                return;
            }
            const sorted = courseCatalogCache
                .slice()
                .sort((a, b) => String(a.title || '').localeCompare(String(b.title || '')));

            host.innerHTML = sorted.map(course => `
                <div class="price-item">
                    <div>
                        <div class="price-title">${course.title || 'Untitled Course'}</div>
                        <div class="price-note">${course.duration || '-'} â€¢ ${course.level || '-'}</div>
                    </div>
                    <div class="price-editor">
                        <input
                            class="price-input"
                            type="number"
                            min="1"
                            step="1"
                            value="${Number.isFinite(Number(course.price)) ? Math.round(Number(course.price)) : ''}"
                            data-price-input="${course.slug}">
                        <button class="price-save-btn" data-save-price="${course.slug}">
                            Save
                        </button>
                    </div>
                </div>
            `).join('');

            host.querySelectorAll('[data-save-price]').forEach(btn => {
                btn.addEventListener('click', () => saveCoursePrice(btn.getAttribute('data-save-price') || ''));
            });
        }

        async function saveCoursePrice(identifier) {
            const slug = String(identifier || '').trim();
            const status = document.getElementById('coursePricingStatus');
            if (!slug) return;
            if (savingCoursePriceSlugs.has(slug)) return;

            const input = document.querySelector(`[data-price-input="${slug}"]`);
            const button = document.querySelector(`[data-save-price="${slug}"]`);
            const raw = input ? input.value : '';
            const price = Number(raw);

            if (!Number.isFinite(price) || price <= 0) {
                if (status) status.textContent = 'Enter a valid positive price before saving.';
                return;
            }

            savingCoursePriceSlugs.add(slug);
            if (button) {
                button.disabled = true;
                button.textContent = 'Saving...';
            }

            try {
                const response = await fetch(`/api/admin/course-pricing/${encodeURIComponent(slug)}`, {
                    method: 'PUT',
                    headers: { ...authHeaders(), 'Content-Type': 'application/json' },
                    body: JSON.stringify({ price: Math.round(price) })
                });
                if (response.status === 401) {
                    localStorage.removeItem(ADMIN_TOKEN_KEY);
                    showAdminLogin();
                    return;
                }
                const data = await response.json();
                if (!response.ok || !data.success || !data.course) {
                    if (status) status.textContent = data.message || 'Unable to update course price.';
                    return;
                }

                const idx = courseCatalogCache.findIndex(item => item.slug === data.course.slug);
                if (idx >= 0) {
                    courseCatalogCache[idx] = {
                        ...courseCatalogCache[idx],
                        ...data.course
                    };
                }

                renderCoursePricing();
                if (status) status.textContent = `Updated ${data.course.title} to ${data.course.priceLabel}.`;
            } catch (error) {
                if (status) status.textContent = 'Network error while updating course price.';
            } finally {
                savingCoursePriceSlugs.delete(slug);
                if (button) {
                    button.disabled = false;
                    button.textContent = 'Save';
                }
            }
        }

        function toDateTimeLocal(value) {
            if (!value) return '';
            const date = new Date(value);
            if (Number.isNaN(date.getTime())) return '';
            const pad = (n) => String(n).padStart(2, '0');
            const yyyy = date.getFullYear();
            const mm = pad(date.getMonth() + 1);
            const dd = pad(date.getDate());
            const hh = pad(date.getHours());
            const min = pad(date.getMinutes());
            return `${yyyy}-${mm}-${dd}T${hh}:${min}`;
        }

        function updateAnnouncementCharCount() {
            const messageEl = document.getElementById('announcementMessage');
            const countEl = document.getElementById('announcementCharCount');
            if (!messageEl || !countEl) return;
            countEl.textContent = String((messageEl.value || '').length);
        }

        function renderAnnouncementPreview() {
            const preview = document.getElementById('announcementPreview');
            if (!preview) return;
            const title = document.getElementById('announcementTitle')?.value?.trim() || '';
            const message = document.getElementById('announcementMessage')?.value?.trim() || '';
            const type = document.getElementById('announcementType')?.value || 'info';
            const ctaText = document.getElementById('announcementCtaText')?.value?.trim() || '';
            const ctaUrl = document.getElementById('announcementCtaUrl')?.value?.trim() || '';

            if (!message) {
                preview.innerHTML = '<div class="small-muted">Preview will appear here.</div>';
                return;
            }

            preview.innerHTML = `
                <div style="display:flex; align-items:center; gap:8px; margin-bottom:6px;">
                    <span class="badge badge-primary" style="text-transform:capitalize;">${type}</span>
                    <span class="small-muted">Live Preview</span>
                </div>
                <div style="font-weight:600; color: var(--primary-dark);">${title || 'Announcement'}</div>
                <div style="margin-top:4px;">${message}</div>
                ${ctaText && ctaUrl ? `<a href="${ctaUrl}" target="_blank" rel="noopener noreferrer" style="display:inline-block; margin-top:8px; color:var(--primary-color); font-weight:600;">${ctaText}</a>` : ''}
            `;
        }

        function getAnnouncementPayloadFromForm() {
            return {
                title: document.getElementById('announcementTitle').value,
                message: document.getElementById('announcementMessage').value,
                type: document.getElementById('announcementType').value,
                ctaText: document.getElementById('announcementCtaText').value,
                ctaUrl: document.getElementById('announcementCtaUrl').value,
                startsAt: document.getElementById('announcementStartsAt').value,
                endsAt: document.getElementById('announcementEndsAt').value,
                dismissible: document.getElementById('announcementDismissible').checked,
                active: document.getElementById('announcementActive').checked
            };
        }

        async function saveAnnouncementPayload(payload, successMessage) {
            const statusEl = document.getElementById('announcementStatus');
            try {
                const response = await fetch('/api/admin/announcement', {
                    method: 'PUT',
                    headers: { ...authHeaders(), 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await response.json();
                if (!response.ok || !data.success) {
                    statusEl.textContent = data.message || 'Unable to save announcement.';
                    return false;
                }
                statusEl.textContent = successMessage || `Saved successfully at ${new Date().toLocaleTimeString('en-IN')}`;
                return true;
            } catch (error) {
                statusEl.textContent = 'Network error while saving announcement.';
                return false;
            }
        }

        async function loadAnnouncement() {
            const statusEl = document.getElementById('announcementStatus');
            if (!statusEl) return;

            try {
                const response = await fetch('/api/admin/announcement', {
                    headers: authHeaders()
                });
                if (response.status === 401) {
                    localStorage.removeItem(ADMIN_TOKEN_KEY);
                    showAdminLogin();
                    return;
                }
                const data = await response.json();
                document.getElementById('announcementTitle').value = data.title || '';
                document.getElementById('announcementMessage').value = data.message || '';
                document.getElementById('announcementType').value = data.type || 'info';
                document.getElementById('announcementCtaText').value = data.ctaText || '';
                document.getElementById('announcementCtaUrl').value = data.ctaUrl || '';
                document.getElementById('announcementStartsAt').value = toDateTimeLocal(data.startsAt);
                document.getElementById('announcementEndsAt').value = toDateTimeLocal(data.endsAt);
                document.getElementById('announcementDismissible').checked = data.dismissible !== false;
                document.getElementById('announcementActive').checked = Boolean(data.active);
                updateAnnouncementCharCount();
                renderAnnouncementPreview();
                statusEl.textContent = data.updatedAt
                    ? `Last updated: ${new Date(data.updatedAt).toLocaleString('en-IN')}`
                    : 'No announcement configured yet.';
            } catch (error) {
                statusEl.textContent = 'Failed to load announcement settings.';
            }
        }

        async function saveAnnouncement(e) {
            e.preventDefault();
            const payload = getAnnouncementPayloadFromForm();
            await saveAnnouncementPayload(payload, `Saved successfully at ${new Date().toLocaleTimeString('en-IN')}`);
            renderAnnouncementPreview();
        }

        async function activateAnnouncementNow() {
            document.getElementById('announcementActive').checked = true;
            document.getElementById('announcementStartsAt').value = '';
            document.getElementById('announcementEndsAt').value = '';
            const payload = getAnnouncementPayloadFromForm();
            await saveAnnouncementPayload(payload, 'Announcement activated now.');
        }

        async function deactivateAnnouncement() {
            document.getElementById('announcementActive').checked = false;
            const payload = getAnnouncementPayloadFromForm();
            await saveAnnouncementPayload(payload, 'Announcement deactivated.');
        }

        async function clearAnnouncementForm() {
            document.getElementById('announcementTitle').value = '';
            document.getElementById('announcementMessage').value = '';
            document.getElementById('announcementType').value = 'info';
            document.getElementById('announcementCtaText').value = '';
            document.getElementById('announcementCtaUrl').value = '';
            document.getElementById('announcementStartsAt').value = '';
            document.getElementById('announcementEndsAt').value = '';
            document.getElementById('announcementDismissible').checked = true;
            document.getElementById('announcementActive').checked = false;
            updateAnnouncementCharCount();
            renderAnnouncementPreview();
            const payload = getAnnouncementPayloadFromForm();
            await saveAnnouncementPayload(payload, 'Announcement cleared.');
        }

        async function loadInsights() {
            try {
                const response = await fetch('/api/admin/insights', {
                    headers: authHeaders()
                });
                if (response.status === 401) {
                    localStorage.removeItem(ADMIN_TOKEN_KEY);
                    showAdminLogin();
                    return;
                }
                const data = await response.json();
                const topCourse = data.topCourse && data.topCourse.course ? data.topCourse.course : 'No data yet';
                document.getElementById('insightTopCourse').textContent = topCourse;
                document.getElementById('insightTodayLeads').textContent = data.todayLeads ?? 0;
                document.getElementById('insightTodayRegistrations').textContent = data.todayRegistrations ?? 0;

                const suggestion = topCourse === 'No data yet'
                    ? 'Suggestion: Collect a few inquiries to unlock demand insights.'
                    : `Suggestion: Run a promo banner for "${topCourse}" this week for better conversions.`;
                document.getElementById('insightSuggestion').textContent = suggestion;
            } catch (error) {
                document.getElementById('insightSuggestion').textContent = 'Failed to load insights.';
            }
        }

        function populateGamificationForm(config) {
            if (!config) return;
            const rewards = config.rewards || {};
            const weekly = config.weeklyChallenge || {};
            document.getElementById('gameXpPerLevel').value = config.xpPerLevel ?? 250;
            document.getElementById('gameEnrollXp').value = rewards.enrollXp ?? 120;
            document.getElementById('gameTopicXp').value = rewards.topicXp ?? 8;
            document.getElementById('gameCompletionXp').value = rewards.completionXp ?? 80;
            document.getElementById('gameDailyBaseXp').value = rewards.dailyBaseXp ?? 10;
            document.getElementById('gameDailyStreakFactor').value = rewards.dailyStreakFactor ?? 2;
            document.getElementById('gameDailyStreakCap').value = rewards.dailyStreakCap ?? 20;
            document.getElementById('gameWeeklyTargetTopics').value = weekly.targetTopics ?? 10;
            document.getElementById('gameWeeklyRewardXp').value = weekly.rewardXp ?? 120;
            document.getElementById('gameWeeklyLabel').value = weekly.label || 'Weekly Sprint';
        }

        function getGamificationPayloadFromForm() {
            return {
                xpPerLevel: Number(document.getElementById('gameXpPerLevel').value),
                rewards: {
                    enrollXp: Number(document.getElementById('gameEnrollXp').value),
                    topicXp: Number(document.getElementById('gameTopicXp').value),
                    completionXp: Number(document.getElementById('gameCompletionXp').value),
                    dailyBaseXp: Number(document.getElementById('gameDailyBaseXp').value),
                    dailyStreakFactor: Number(document.getElementById('gameDailyStreakFactor').value),
                    dailyStreakCap: Number(document.getElementById('gameDailyStreakCap').value)
                },
                weeklyChallenge: {
                    targetTopics: Number(document.getElementById('gameWeeklyTargetTopics').value),
                    rewardXp: Number(document.getElementById('gameWeeklyRewardXp').value),
                    label: document.getElementById('gameWeeklyLabel').value
                }
            };
        }

        async function loadGamificationConfig() {
            const statusEl = document.getElementById('gamificationStatus');
            if (!statusEl) return;

            try {
                const response = await fetch('/api/admin/gamification-config', {
                    headers: authHeaders()
                });
                if (response.status === 401) {
                    localStorage.removeItem(ADMIN_TOKEN_KEY);
                    showAdminLogin();
                    return;
                }
                const data = await response.json();
                if (!response.ok || !data.success) {
                    statusEl.textContent = data.message || 'Failed to load gamification settings.';
                    return;
                }
                gamificationConfigCache = data.config;
                populateGamificationForm(gamificationConfigCache);
                statusEl.textContent = 'Gamification settings loaded.';
            } catch (error) {
                statusEl.textContent = 'Network error while loading gamification settings.';
            }
        }

        async function saveGamificationConfig() {
            const statusEl = document.getElementById('gamificationStatus');
            if (!statusEl) return;
            const payload = getGamificationPayloadFromForm();
            try {
                const response = await fetch('/api/admin/gamification-config', {
                    method: 'PUT',
                    headers: { ...authHeaders(), 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await response.json();
                if (!response.ok || !data.success) {
                    statusEl.textContent = data.message || 'Unable to save gamification settings.';
                    return;
                }
                gamificationConfigCache = data.config;
                populateGamificationForm(gamificationConfigCache);
                statusEl.textContent = `Saved successfully at ${new Date().toLocaleTimeString('en-IN')}`;
            } catch (error) {
                statusEl.textContent = 'Network error while saving gamification settings.';
            }
        }

        function resetGamificationForm() {
            if (gamificationConfigCache) {
                populateGamificationForm(gamificationConfigCache);
            }
        }
        
        async function loadInquiries() {
            const tableBody = document.getElementById('inquiriesTable');
            
            try {
                const response = await fetch('/api/inquiries', {
                    headers: authHeaders()
                });
                if (response.status === 401) {
                    localStorage.removeItem(ADMIN_TOKEN_KEY);
                    showAdminLogin();
                    return;
                }
                const inquiries = await response.json();
                inquiriesCache = Array.isArray(inquiries)
                    ? inquiries.map(item => ({
                        ...item,
                        status: item.status === 'resolved' ? 'resolved' : 'pending'
                    }))
                    : [];
                
                if (inquiriesCache.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="9" class="no-inquiries">
                                <i class="fas fa-inbox"></i>
                                <p>No inquiries yet. When someone submits the contact form, they will appear here.</p>
                            </td>
                        </tr>
                    `;
                    updateStats(0, 0, 0, 0);
                    populateCourseFilter('inquiryCourseFilter', [], 'All Inquiry Courses');
                    renderCourseLeaderboard();
                    renderRecentActivity();
                    return;
                }

                renderInquiriesTable();
                
                // Update stats
                const today = new Date().toDateString();
                const todayCount = inquiriesCache.filter(i => new Date(i.date).toDateString() === today).length;
                const pythonCount = inquiriesCache.filter(i => i.course && i.course.toLowerCase().includes('python')).length;
                const webCount = inquiriesCache.filter(i => i.course && i.course.toLowerCase().includes('web')).length;
                
                updateStats(inquiriesCache.length, todayCount, pythonCount, webCount);
                populateCourseFilter('inquiryCourseFilter', inquiriesCache.map(i => i.course), 'All Inquiry Courses');
                renderCourseLeaderboard();
                renderRecentActivity();
                
            } catch (error) {
                console.error('Error loading inquiries:', error);
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="9" class="no-inquiries">
                            <i class="fas fa-exclamation-triangle"></i>
                            <p>Error loading inquiries. Please try again.</p>
                        </td>
                    </tr>
                `;
                inquiriesCache = [];
            }
        }

        async function loadUsers() {
            const tableBody = document.getElementById('usersTable');

            try {
                const response = await fetch('/api/users', {
                    headers: authHeaders()
                });
                if (response.status === 401) {
                    localStorage.removeItem(ADMIN_TOKEN_KEY);
                    showAdminLogin();
                    return;
                }
                const users = await response.json();
                usersCache = Array.isArray(users) ? users : [];

                if (usersCache.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="9" class="no-inquiries">
                                <i class="fas fa-user-slash"></i>
                                <p>No registered users yet.</p>
                            </td>
                        </tr>
                    `;
                    updateUserStats(0, 0);
                    populateCourseFilter('userCourseFilter', [], 'All User Courses');
                    renderCourseLeaderboard();
                    renderRecentActivity();
                    return;
                }

                renderUsersTable();

                const today = new Date().toDateString();
                const todayCount = usersCache.filter(u => new Date(u.createdAt).toDateString() === today).length;
                updateUserStats(usersCache.length, todayCount);
                populateCourseFilter('userCourseFilter', usersCache.map(u => u.course), 'All User Courses');
                renderCourseLeaderboard();
                renderRecentActivity();
            } catch (error) {
                console.error('Error loading users:', error);
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="9" class="no-inquiries">
                            <i class="fas fa-exclamation-triangle"></i>
                            <p>Error loading users. Please try again.</p>
                        </td>
                    </tr>
                `;
                updateUserStats(0, 0);
                usersCache = [];
            }
        }

        function normalizeText(value) {
            return String(value || '').toLowerCase().trim();
        }

        function getInquiryFilters() {
            const search = normalizeText(document.getElementById('inquirySearchInput')?.value);
            const course = normalizeText(document.getElementById('inquiryCourseFilter')?.value);
            return { search, course };
        }

        function getUserFilters() {
            const search = normalizeText(document.getElementById('userSearchInput')?.value);
            const course = normalizeText(document.getElementById('userCourseFilter')?.value);
            return { search, course };
        }

        function getFilteredInquiries() {
            const { search, course } = getInquiryFilters();
            return inquiriesCache.filter(item => {
                const courseName = normalizeText(item.course || 'general');
                const searchBlob = normalizeText(`${item.name} ${item.email} ${item.phone} ${item.course} ${item.message} ${item.status}`);
                const matchSearch = !search || searchBlob.includes(search);
                const matchCourse = !course || courseName === course;
                return matchSearch && matchCourse;
            });
        }

        function getFilteredUsers() {
            const { search, course } = getUserFilters();
            return usersCache.filter(item => {
                const courseName = normalizeText(item.course || 'general');
                const searchBlob = normalizeText(`${item.firstName} ${item.lastName} ${item.email} ${item.phone} ${item.course}`);
                const matchSearch = !search || searchBlob.includes(search);
                const matchCourse = !course || courseName === course;
                return matchSearch && matchCourse;
            });
        }

        function renderInquiriesTable() {
            const tableBody = document.getElementById('inquiriesTable');
            const filtered = getFilteredInquiries();
            if (!filtered.length) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="9" class="no-inquiries">
                            <i class="fas fa-filter-circle-xmark"></i>
                            <p>No inquiries match the current filters.</p>
                        </td>
                    </tr>
                `;
                return;
            }

            const sortedInquiries = filtered.slice().reverse();
            tableBody.innerHTML = sortedInquiries.map(inquiry => {
                const date = new Date(inquiry.date);
                const formattedDate = date.toLocaleDateString('en-IN', {
                    day: '2-digit',
                    month: 'short',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                return `
                    <tr>
                        <td><strong>#${inquiry.id}</strong></td>
                        <td>${inquiry.name}</td>
                        <td><a href="mailto:${inquiry.email}">${inquiry.email}</a></td>
                        <td><a href="tel:${inquiry.phone}">${inquiry.phone}</a></td>
                        <td><span class="badge badge-primary">${inquiry.course}</span></td>
                        <td>
                            <span class="badge ${inquiry.status === 'resolved' ? 'badge-success' : 'badge-primary'}">
                                ${inquiry.status === 'resolved' ? 'Resolved' : 'Pending'}
                            </span>
                        </td>
                        <td>${inquiry.message || '-'}</td>
                        <td class="date">${formattedDate}</td>
                        <td>
                            <button class="table-action-btn" onclick="toggleInquiryStatusFromAdmin(${inquiry.id})">
                                ${inquiry.status === 'resolved' ? 'Mark Pending' : 'Mark Resolved'}
                            </button>
                            <button class="table-action-btn danger" onclick="deleteInquiryFromAdmin(${inquiry.id})">Delete</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function getInquiryById(inquiryId) {
            return inquiriesCache.find(item => Number(item.id) === Number(inquiryId));
        }

        async function toggleInquiryStatusFromAdmin(inquiryId) {
            const inquiry = getInquiryById(inquiryId);
            if (!inquiry) {
                alert('Inquiry not found.');
                return;
            }

            const nextStatus = inquiry.status === 'resolved' ? 'pending' : 'resolved';
            try {
                const response = await fetch(`/api/inquiries/${encodeURIComponent(inquiryId)}`, {
                    method: 'PUT',
                    headers: { ...authHeaders(), 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: nextStatus })
                });
                const data = await response.json();
                if (!response.ok || !data.success) {
                    alert(data.message || 'Unable to update inquiry status.');
                    return;
                }
                await loadInquiries();
            } catch (error) {
                alert(`Network error while updating inquiry: ${error.message || 'Unknown error'}`);
            }
        }

        async function deleteInquiryFromAdmin(inquiryId) {
            const inquiry = getInquiryById(inquiryId);
            if (!inquiry) {
                alert('Inquiry not found.');
                return;
            }

            const confirmed = confirm(`Delete inquiry from "${inquiry.name}"? This action cannot be undone.`);
            if (!confirmed) return;

            try {
                let response = await fetch(`/api/inquiries/${encodeURIComponent(inquiryId)}`, {
                    method: 'DELETE',
                    headers: authHeaders()
                });

                if (response.status === 404 || response.status === 405) {
                    response = await fetch(`/api/inquiries/${encodeURIComponent(inquiryId)}/delete`, {
                        method: 'POST',
                        headers: authHeaders()
                    });
                }

                let data = null;
                const raw = await response.text();
                try {
                    data = raw ? JSON.parse(raw) : null;
                } catch (error) {
                    data = null;
                }

                if (!response.ok || !data || !data.success) {
                    alert((data && data.message) || `Unable to delete inquiry (HTTP ${response.status}).`);
                    return;
                }
                await loadInquiries();
            } catch (error) {
                alert(`Network error while deleting inquiry: ${error.message || 'Unknown error'}`);
            }
        }

        function renderUsersTable() {
            const tableBody = document.getElementById('usersTable');
            const filtered = getFilteredUsers();
            if (!filtered.length) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="9" class="no-inquiries">
                            <i class="fas fa-filter-circle-xmark"></i>
                            <p>No users match the current filters.</p>
                        </td>
                    </tr>
                `;
                return;
            }

            const sortedUsers = filtered.slice().reverse();
            tableBody.innerHTML = sortedUsers.map(user => {
                const date = new Date(user.createdAt);
                const formattedDate = date.toLocaleDateString('en-IN', {
                    day: '2-digit',
                    month: 'short',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                return `
                    <tr>
                        <td><strong>#${user.id}</strong></td>
                        <td>${user.firstName || '-'}</td>
                        <td>${user.lastName || '-'}</td>
                        <td><a href="mailto:${user.email}">${user.email}</a></td>
                        <td><a href="tel:${user.phone}">${user.phone}</a></td>
                        <td><span class="badge badge-success">${user.course || 'General'}</span></td>
                        <td>
                            <span class="badge ${user.accountStatus === 'blocked' ? 'badge-warning' : 'badge-success'}">
                                ${user.accountStatus === 'blocked' ? 'Blocked' : 'Active'}
                            </span>
                        </td>
                        <td class="date">${formattedDate}</td>
                        <td>
                            <button class="table-action-btn" onclick="editUserFromAdmin(${user.id})">Edit</button>
                            <button class="table-action-btn" onclick="toggleUserStatusFromAdmin(${user.id})">
                                ${user.accountStatus === 'blocked' ? 'Activate' : 'Block'}
                            </button>
                            <button class="table-action-btn danger" onclick="deleteUserFromAdmin(${user.id})">Delete</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function getUserById(userId) {
            return usersCache.find(user => Number(user.id) === Number(userId));
        }

        async function editUserFromAdmin(userId) {
            const user = getUserById(userId);
            if (!user) {
                alert('User not found.');
                return;
            }

            const firstName = prompt('First Name', user.firstName || '');
            if (firstName === null) return;
            const lastName = prompt('Last Name', user.lastName || '');
            if (lastName === null) return;
            const phone = prompt('Phone Number', user.phone || '');
            if (phone === null) return;
            const course = prompt('Course Name', user.course || '');
            if (course === null) return;

            try {
                const response = await fetch(`/api/users/${encodeURIComponent(userId)}`, {
                    method: 'PUT',
                    headers: { ...authHeaders(), 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        firstName,
                        lastName,
                        phone,
                        course,
                        accountStatus: user.accountStatus === 'blocked' ? 'blocked' : 'active'
                    })
                });
                const data = await response.json();
                if (!response.ok || !data.success) {
                    alert(data.message || 'Unable to update user.');
                    return;
                }
                await loadUsers();
                renderCourseLeaderboard();
                renderRecentActivity();
            } catch (error) {
                alert('Network error while updating user.');
            }
        }

        async function toggleUserStatusFromAdmin(userId) {
            const user = getUserById(userId);
            if (!user) {
                alert('User not found.');
                return;
            }

            const nextStatus = user.accountStatus === 'blocked' ? 'active' : 'blocked';
            const confirmed = confirm(
                nextStatus === 'blocked'
                    ? `Block ${user.firstName || user.email}? They will not be able to login.`
                    : `Activate ${user.firstName || user.email}?`
            );
            if (!confirmed) return;

            try {
                const response = await fetch(`/api/users/${encodeURIComponent(userId)}`, {
                    method: 'PUT',
                    headers: { ...authHeaders(), 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        firstName: user.firstName || '',
                        lastName: user.lastName || '',
                        phone: user.phone || '',
                        course: user.course || '',
                        accountStatus: nextStatus
                    })
                });
                const data = await response.json();
                if (!response.ok || !data.success) {
                    alert(data.message || 'Unable to update user status.');
                    return;
                }
                await loadUsers();
            } catch (error) {
                alert('Network error while updating user status.');
            }
        }

        async function deleteUserFromAdmin(userId) {
            const user = getUserById(userId);
            if (!user) {
                alert('User not found.');
                return;
            }

            const confirmed = confirm(`Delete user "${user.firstName || ''} ${user.lastName || ''}". This action cannot be undone.`);
            if (!confirmed) return;

            try {
                let response = await fetch(`/api/users/${encodeURIComponent(userId)}`, {
                    method: 'DELETE',
                    headers: authHeaders()
                });

                if (response.status === 404 || response.status === 405) {
                    response = await fetch(`/api/users/${encodeURIComponent(userId)}/delete`, {
                        method: 'POST',
                        headers: authHeaders()
                    });
                }

                let data = null;
                const raw = await response.text();
                try {
                    data = raw ? JSON.parse(raw) : null;
                } catch (error) {
                    data = null;
                }

                if (!response.ok || !data || !data.success) {
                    alert((data && data.message) || `Unable to delete user (HTTP ${response.status}).`);
                    return;
                }
                await loadUsers();
                renderCourseLeaderboard();
                renderRecentActivity();
            } catch (error) {
                alert(`Network error while deleting user: ${error.message || 'Unknown error'}`);
            }
        }

        function populateCourseFilter(selectId, courses, defaultLabel) {
            const selectEl = document.getElementById(selectId);
            if (!selectEl) return;
            const currentValue = selectEl.value;
            const uniqueCourses = [...new Set((courses || [])
                .map(c => String(c || 'General').trim())
                .filter(Boolean))]
                .sort((a, b) => a.localeCompare(b));

            selectEl.innerHTML = `<option value="">${defaultLabel}</option>` +
                uniqueCourses.map(course => `<option value="${course}">${course}</option>`).join('');

            if (currentValue && uniqueCourses.includes(currentValue)) {
                selectEl.value = currentValue;
            }
        }

        function renderCourseLeaderboard() {
            const host = document.getElementById('courseLeaderboard');
            if (!host) return;
            const score = new Map();
            inquiriesCache.forEach(item => {
                const key = String(item.course || 'General').trim() || 'General';
                score.set(key, (score.get(key) || 0) + 1);
            });
            usersCache.forEach(item => {
                const key = String(item.course || 'General').trim() || 'General';
                score.set(key, (score.get(key) || 0) + 2);
            });

            const ranked = [...score.entries()]
                .map(([course, points]) => ({ course, points }))
                .sort((a, b) => b.points - a.points)
                .slice(0, 6);

            if (!ranked.length) {
                host.innerHTML = `<div class="small-muted">No course activity yet.</div>`;
                return;
            }

            host.innerHTML = ranked.map((item, idx) => `
                <div class="leaderboard-item">
                    <div><span class="leaderboard-rank">#${idx + 1}</span>${item.course}</div>
                    <strong>${item.points} pts</strong>
                </div>
            `).join('');
        }

        function renderRecentActivity() {
            const host = document.getElementById('recentActivity');
            if (!host) return;

            const activity = [
                ...inquiriesCache.map(item => ({
                    type: 'Inquiry',
                    title: item.name || 'Unknown',
                    meta: item.course || 'General',
                    date: item.date
                })),
                ...usersCache.map(item => ({
                    type: 'Registration',
                    title: `${item.firstName || ''} ${item.lastName || ''}`.trim() || item.email,
                    meta: item.course || 'General',
                    date: item.createdAt
                }))
            ]
            .filter(item => item.date)
            .sort((a, b) => new Date(b.date) - new Date(a.date))
            .slice(0, 10);

            if (!activity.length) {
                host.innerHTML = `<div class="small-muted">No recent activity yet.</div>`;
                return;
            }

            host.innerHTML = activity.map(item => `
                <div class="activity-item">
                    <div><strong>${item.type}</strong>: ${item.title}</div>
                    <div class="small-muted">${item.meta} â€¢ ${new Date(item.date).toLocaleString('en-IN')}</div>
                </div>
            `).join('');
        }

        function toCsv(rows, columns) {
            const escape = (value) => `"${String(value ?? '').replace(/"/g, '""')}"`;
            const header = columns.map(c => escape(c.label)).join(',');
            const body = rows.map(row => columns.map(c => escape(row[c.key])).join(',')).join('\n');
            return `${header}\n${body}`;
        }

        function downloadCsv(filename, csvText) {
            const blob = new Blob([csvText], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
        }

        function exportInquiriesCsv() {
            const rows = getFilteredInquiries().map(item => ({
                id: item.id,
                name: item.name,
                email: item.email,
                phone: item.phone,
                course: item.course,
                status: item.status || 'pending',
                message: item.message || '',
                date: item.date
            }));
            const csv = toCsv(rows, [
                { key: 'id', label: 'ID' },
                { key: 'name', label: 'Name' },
                { key: 'email', label: 'Email' },
                { key: 'phone', label: 'Phone' },
                { key: 'course', label: 'Course' },
                { key: 'status', label: 'Status' },
                { key: 'message', label: 'Message' },
                { key: 'date', label: 'Date' }
            ]);
            downloadCsv(`inquiries-${new Date().toISOString().slice(0, 10)}.csv`, csv);
        }

        function exportUsersCsv() {
            const rows = getFilteredUsers().map(item => ({
                id: item.id,
                firstName: item.firstName || '',
                lastName: item.lastName || '',
                email: item.email,
                phone: item.phone,
                course: item.course || 'General',
                accountStatus: item.accountStatus || 'active',
                createdAt: item.createdAt
            }));
            const csv = toCsv(rows, [
                { key: 'id', label: 'ID' },
                { key: 'firstName', label: 'First Name' },
                { key: 'lastName', label: 'Last Name' },
                { key: 'email', label: 'Email' },
                { key: 'phone', label: 'Phone' },
                { key: 'course', label: 'Course' },
                { key: 'accountStatus', label: 'Status' },
                { key: 'createdAt', label: 'Registered On' }
            ]);
            downloadCsv(`users-${new Date().toISOString().slice(0, 10)}.csv`, csv);
        }

        function bindAdminControls() {
            document.getElementById('inquirySearchInput')?.addEventListener('input', renderInquiriesTable);
            document.getElementById('inquiryCourseFilter')?.addEventListener('change', renderInquiriesTable);
            document.getElementById('userSearchInput')?.addEventListener('input', renderUsersTable);
            document.getElementById('userCourseFilter')?.addEventListener('change', renderUsersTable);
            document.getElementById('exportInquiriesBtn')?.addEventListener('click', exportInquiriesCsv);
            document.getElementById('exportUsersBtn')?.addEventListener('click', exportUsersCsv);
            document.getElementById('announcementActivateNowBtn')?.addEventListener('click', activateAnnouncementNow);
            document.getElementById('announcementDeactivateBtn')?.addEventListener('click', deactivateAnnouncement);
            document.getElementById('announcementClearBtn')?.addEventListener('click', clearAnnouncementForm);
            ['announcementTitle', 'announcementMessage', 'announcementType', 'announcementCtaText', 'announcementCtaUrl']
                .forEach(id => {
                    const el = document.getElementById(id);
                    if (!el) return;
                    el.addEventListener('input', renderAnnouncementPreview);
                    el.addEventListener('change', renderAnnouncementPreview);
                });
            document.getElementById('announcementMessage')?.addEventListener('input', updateAnnouncementCharCount);
            document.getElementById('saveGamificationBtn')?.addEventListener('click', saveGamificationConfig);
            document.getElementById('resetGamificationBtn')?.addEventListener('click', resetGamificationForm);
            document.getElementById('resetThemeBtn')?.addEventListener('click', resetThemeToDefault);
            document.addEventListener('site-theme-change', () => {
                renderThemeManager();
                setThemeStatus(`Active theme: ${getCurrentThemeFromMain()}`);
            });
        }
        
        function updateStats(total, today, python, web) {
            document.getElementById('totalInquiries').textContent = total;
            document.getElementById('todayInquiries').textContent = today;
            document.getElementById('pythonInquiries').textContent = python;
            document.getElementById('webInquiries').textContent = web;
        }

        function updateUserStats(totalUsers, todayRegistrations) {
            document.getElementById('totalUsers').textContent = totalUsers;
            document.getElementById('todayRegistrations').textContent = todayRegistrations;
        }

        document.getElementById('announcementForm').addEventListener('submit', saveAnnouncement);
        bindAdminControls();
        renderThemeManager();
        setThemeStatus(`Active theme: ${getCurrentThemeFromMain()}`);
    </script>
</body>
</html>
